{% load wagtailcore_tags %}
{% load staticfiles %}

<table class="table table-striped" id="results-table">
    <thead class="table-borderless align-items-center">
        <tr style="font-size: 14px;line-height: 50px; vertical-align: middle;">
            <th scope="col" class="text-center">
                <a href="#" class="text-nowrap text-dark" data-toggle="collapse" data-target=".multi-collapse" aria-expanded="false"
                    style="text-decoration: underline;">Expand all</a>
            </th>
            <th scope="col">Location</th>
            <th scope="col">Data</th>
            <th scope="col" class="pr-0 pt-0">
                <div class="form-inline align-items-center">
                    <label class="mr-sm-2" for="sortby">Sort by: </label>
                    <select class="custom-select" id="sortby" aria-placeholder="Sort by.." style="border-radius:0;">
                        <option value="Relevance">Relevance</option>
                        <option value="Location">Location (A-Z)</option>
                    </select>
                </div>
            </th>
        </tr>
    </thead>
    <tbody class="table-bordered accordion list" style="font-size: 12px;">
        {% for result in results %}
        <!-- The first empty tr helps with table-striped -->
        <tr></tr>
        <tr id="result">
            <td scope="row" style="border-left: 1px solid transparent;" class="align-middle text-center expand">
                <a class="btn btn-link btn-sm text-dark" data-toggle="collapse" data-target="#{{ forloop.counter }}{{ result.category|slugify }}" role="button" aria-expanded="false" 
                    aria-controls="{{ result.data_point.value.title|slugify }}}">
                    <span class="icon fa fa-fw fa-plus"></span>
                </a>
            </td>
            <td class="text-capitalize px-0 align-middle location" style="white-space:nowrap">
                <span class="d-flex mb-2">
                    <b class="col-5">Country:</b>
                    <span class="col pl-3">{{ result.country|slugify }}</span>
                </span>
                <span class="d-flex justify-content-center">
                    <b class="col-5">Region:</b>
                    <span class="col pl-3">{{ result.region|slugify }}</span>
                </span>
            </td>
            <td class="text-capitalize px-0 data" style="white-space:wrap;">
                <span class="d-flex mb-2">
                    <b class="col-5">Category:</b>
                    <span class="col pl-1">{{ result.category|slugify }}</span>
                </span>
                <span class="d-flex">
                    <b class="col-5">Data point:</b>
                    <span class="col pl-1">{{ result.data_point.value.title }}</span>
                </span>
            </td>
            <td style="border-right: 1px solid transparent;" class="text-center align-middle collection">
                <button class="btn btn-link btn-sm font-weight-bold">
                    <i class="far fa-heart mx-1"></i>
                    Add to collection
                </button>
            </td>
        </tr>
        <tr class="collapse multi-collapse table-borderless" id="{{ forloop.counter }}{{ result.category|slugify }}" 
            data-parent="{{ forloop.counter }}{{ result.category|slugify }}">
            <td colspan="4"
                style="border: 0!important;
                {% if forloop.counter|divisibleby:2 %}background-color: rgba(0,0,0,.05);{% else %}background-color: #ffffff;{% endif %}">
                <div id="{{ result.data_point.value.title|slugify }}" class="carousel slide {% if forloop.counter|divisibleby:2 %} odd {% endif %}">                
                    <ol class="carousel-indicators">
                        {% for indicator in result.data_point.value.indicators %}
                            <li data-target="#{{ result.data_point.value.title|slugify }}" data-slide-to="{{ forloop.counter0 }}" class="{% if forloop.first %} active {% endif %}"></li>
                        {% endfor %}
                    </ol>
                    <div class="carousel-inner">
                        {% for indicator in result.data_point.value.indicators %}
                            <div class="carousel-item {% if forloop.first %} active {% endif %}">
                                {% include_block indicator %}
                            </div>
                        {% endfor %}
                        {% if not result.data_point.value.indicators %}
                            <div class="alert alert-info" role="alert">
                                <span class="fas fa-info"></span>
                                <span class="ml-2">We are working to source additional data for this topic. Please 
                                    <a href="http://eepurl.com/dynuAX" target="_blank" rel="noopener">subscribe</a>
                                    to receive an alert when the data is updated.
                                </span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </td>
        </tr>
             
        {% endfor %}
    </tbody>
</table>
<style>
    .noBorder td, .transBorder {
        border: 1px solid transparent;
    }
    .carousel-inner .btn-group {
        border: 1px solid #dedede;
    }
    .odd .carousel-inner .btn-group .btn {
        background: #dedede;
    }
    .carousel-inner .btn-group .btn {
        border-radius: 0;
        background: #fff;
    }
    .carousel-indicators li {
        background-color: #6c757d;
    }
    .carousel-indicators li.active {
        background-color: #000000;
    }
    .odd .nav-tabs .nav-item.show .nav-link, 
    .odd .nav-tabs .nav-link.active {
        background-color: transparent;
        border-bottom-color: transparent;
    }
</style>

<!-- Results - Toggle opening and closing accordion. -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        $('a[data-toggle="collapse"]').click(function () {
            var btn = $(this);
            console.log(btn.attr('data-target'));
            //on close collapse
            $('.collapse'+btn.attr('data-target')).on('hide.bs.collapse', function () {
                // Change collapse button state
                btn.find('.icon').addClass('fa-plus');

                var target = '#'+$(this).attr('data-parent');
                // Remove borders
                $(target).removeClass('noBorder');
                $('tbody.table-bordered').removeClass('transBorder');
                $(target).prev('tr#result').removeClass('noBorder');
            });

            //on open collapse
            $('.collapse'+btn.attr('data-target')).on('show.bs.collapse', function () {
                // Change collapse button state
                btn.find('.icon').toggleClass('fa-minus');

                var target = '#'+$(this).attr('data-parent');
                // Add back borders
                $(target).addClass('noBorder');
                $('tbody.table-bordered').addClass('transBorder');
                $(target).prev('tr#result').addClass('noBorder');
            })
        });

        
    getPagination('#results-table');

    /*					PAGINATION 
    - on change max rows select options fade out all rows gt option value mx = 25
    - append pagination list as per numbers of rows / max rows option (100row/25= 4pages )
    - each pagination li on click -> fade out all tr gt max rows * li num and (25*pagenum 2 = 50 rows)
    - fade out all tr lt max rows * li num - max rows ((25*pagenum 2 = 10) - 25)
    - fade in all tr between (maxRows*PageNum) and (maxRows*pageNum)- MaxRows 
    */

    function getPagination(table) {

        var lastPage = 1;

        $('#maxRows').on('change', function (evt) {
            //$('.paginationprev').html('');	// reset pagination

            lastPage = 1;
            $('.pagination').find("li").slice(1, -1).remove();
            var trnum = 0; // reset tr counter 
            var maxRows = parseInt($(this).val()); // get Max Rows from select option

            if (maxRows == 100) {
                $('.pagination').hide();
            } else {

                $('.pagination').show();
            }

            var totalRows = $(table + ' tbody tr#result').length; // numbers of rows 
            $(table + ' tr#result:gt(0)').each(function () { // each TR in  table and not the header
                trnum++; // Start Counter
                if (trnum > maxRows) { // if tr number gt maxRows

                    $(this).hide(); // fade it out 
                }
                if (trnum <= maxRows) {
                    $(this).show();
                } // else fade in Important in case if it ..
            }); //  was fade out to fade it in 
            if (totalRows > maxRows) { // if tr total rows gt max rows option
                var pagenum = Math.ceil(totalRows / maxRows); // ceil total(rows/maxrows) to get ..  
                //	numbers of pages 
                for (var i = 1; i <= pagenum;) { // for each page append pagination li 
                    $('.pagination #prev').before('<li class="page-item" data-page="' + i + '">\
                        <a class="page-link mx-1">' + i++ + '<span class="sr-only">(current)</span></a>\
                    </li>').show();
                } // end for i 
            } // end if row count > max rows
            else{
                $('.pagination').hide();
            }
            $('.pagination [data-page="1"]').addClass('active'); // add active class to the first li 
            $('.pagination li').on('click', function (evt) { // on click each page
                evt.stopImmediatePropagation();
                evt.preventDefault();
                var pageNum = $(this).attr('data-page'); // get it's number

                var maxRows = parseInt($('#maxRows').val()); // get Max Rows from select option

                if (pageNum == "prev") {
                    if (lastPage == 1) {
                        return;
                    }
                    pageNum = --lastPage;
                }
                if (pageNum == "next") {
                    if (lastPage == ($('.pagination li').length - 2)) {
                        return;
                    }
                    pageNum = ++lastPage;
                }

                lastPage = pageNum;
                var trIndex = 0; // reset tr counter
                $('.pagination li').removeClass('active'); // remove active class from all li 
                $('.pagination [data-page="' + lastPage + '"]').addClass('active'); // add active class to the clicked 
                // $(this).addClass('active');					// add active class to the clicked 
                $(table + ' tr#result:gt(0)').each(function () { // each tr in table not the header
                    trIndex++; // tr index counter 
                    // if tr index gt maxRows*pageNum or lt maxRows*pageNum-maxRows fade if out
                    if (trIndex > (maxRows * pageNum) || trIndex <= ((maxRows * pageNum) - maxRows)) {
                        $(this).hide();
                    } else {
                        $(this).show();
                    } //else fade in 
                }); // end of for each tr in table
            }); // end of on click pagination list

        }).val(25).change();
        // end of on select change 
    // END OF PAGINATION 
    }
    });
</script>